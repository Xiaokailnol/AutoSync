name: ğŸ¤– åŒæ­¥æ›´æ–°

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'é€‰æ‹©è¦åŒæ­¥çš„ OpenWrt ä¸Šæ¸¸ç»„ä»¶'
        required: true
        default: 'openwrt_helloworld'
        type: choice
        options:
          - 'openwrt_helloworld'
          - 'openwrt_packages'
          - 'packages_lang_golang'
          - 'packages_utils_containerd'
          - 'packages_utils_runc'
          - 'packages_utils_dockerd'
          - 'packages_utils_docker'
          - 'package_kernel_r8125'
          - 'package_kernel_r8126'
          - 'package_kernel_r8127'
          - 'package_kernel_r8101'
          - 'package_kernel_r8152'
          - 'package_kernel_r8168'
          - 'package_kernel_mt76'
          - 'package_kernel_mac80211'
          - 'package_utils_util-linux'
          - 'package_kernel_ath10k-ct'
          - 'package_firmware_linux-firmware'
          - 'target_linux_generic'
          - 'target_linux_rockchip-6.x'
          - 'target_linux_x86'
  schedule:
    - cron: '0 16 * * *'   # åŒ—äº¬æ—¶é—´æ¯å¤© 00:00
    
jobs:
  build:
    name: ğŸŸ¢ åŒæ­¥æ¨¡å— â†’ ${{ github.event.inputs.target }}
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash

    steps:
    - name: ğŸ“¥ æ‹‰å–ä»“åº“æºç 
      continue-on-error: true
      uses: actions/checkout@main
      with:
        path: AutoSync

    - name: ğŸš€ Runner ç¯å¢ƒå‡†å¤‡ä¸ Git é…ç½®
      run : |
        sudo timedatectl set-timezone 'Asia/Shanghai'
        git config --global user.email "2519840456@qq.com"
        git config --global user.name "Xiaokailnol"
        echo build_dir="/builder" >> "$GITHUB_ENV"

    - name: ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯å±•ç¤º
      run: |
        echo -e "\n\e[1;32mCPU:\e[0m"
        echo "$(grep 'model name' /proc/cpuinfo | head -1 | awk -F ': ' '{print $2}') ($(grep 'cpu MHz' /proc/cpuinfo | head -1 | awk -F ': ' '{print $2}')MHz) x $(grep processor /proc/cpuinfo  | wc -l)"
        echo -e "\n\e[1;32mMemory:\e[0m"
        free -h
        echo -e "\n\e[1;32mStorage:\e[0m"
        df -Th / /mnt
        echo -e "\n\e[1;32mSystem:\e[0m"
        lsb_release -a
        echo -e "\n\e[1;32mKernel:\e[0m"
        uname -a
        echo

    - name: ğŸŒ éƒ¨ç½² Caddy æœåŠ¡ç¯å¢ƒ
      run: |
        sudo curl -sL -o /usr/bin/caddy https://github.com/Xiaokailnol/AutoSync/releases/download/tools/caddy
        sudo chmod 755 /usr/bin/caddy
        echo ":8080 {" > caddyfile
        echo "    root * $(pwd)/AutoSync" >> caddyfile
        echo "    file_server browse" >> caddyfile
        echo "}" >> caddyfile
        sudo /usr/bin/caddy start --config caddyfile --adapter caddyfile

    - name: ğŸ’¾ å¯ç”¨ç£ç›˜ç©ºé—´
      uses: Xiaokailnol/actions@free-disk
      with:
        build-mount-path: /builder
        
    - name: âš™ï¸ ä¸Šæ¸¸æºä»£ç åŒæ­¥ä¸æ›´æ–°
      working-directory: /builder
      id: sync
      run: |
        git clone -b openwrt-25.12 https://github.com/Xiaokailnol/${{ github.event.inputs.target }}.git ${{ github.event.inputs.target }}
        cd ${{ github.event.inputs.target }}
        git rm -r --cache * >/dev/null 2>&1 &
        rm -rf `find ./* -maxdepth 0 -type d ! -name "commit"` >/dev/null 2>&1
        if [[ "${{ github.event.inputs.target }}" == "openwrt_helloworld" || "${{ github.event.inputs.target }}" == "openwrt_packages" ]]; then
          bash <(curl -sS "http://127.0.0.1:8080/.github/diy/${{ github.event.inputs.target }}.sh")
          bash <(curl -sS "http://127.0.0.1:8080/.github/diy/convert_translation.sh")
          bash <(curl -sS "http://127.0.0.1:8080/.github/diy/create_acl_for_luci.sh") -a
          bash <(curl -sS "http://127.0.0.1:8080/.github/diy/Modify.sh")
        else
          bash <(curl -sS "http://127.0.0.1:8080/.github/diy/openwrt_target.sh") ${{ github.event.inputs.target }}
        fi  
        echo "status=success" >> ${GITHUB_OUTPUT}

    - name: ğŸ“¤ æ¨é€è‡³è¿œç¨‹ä»“åº“
      if: ${{ steps.sync.outputs.status == 'success' && !cancelled() }}
      working-directory: /builder
      env: 
        ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
      run: |
        cd ${{ github.event.inputs.target }}
        if git status --porcelain | grep .; then
          Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
          git add .
          git commit -am "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
          git push --quiet "https://${{ secrets.ACCESS_TOKEN }}@github.com/Xiaokailnol/${{ github.event.inputs.target }}.git" HEAD:openwrt-25.12
        else
          echo "nothing to commit"
          exit 0
        fi || exit 0
