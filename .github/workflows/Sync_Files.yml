name: ðŸ¤– åŒæ­¥æ›´æ–°

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'é€‰æ‹©è¦åŒæ­¥çš„ OpenWrt ä¸Šæ¸¸ç»„ä»¶'
        required: true
        default: 'OpenWrt æ’ä»¶'
        type: choice
        options:
          - 'Docker ç›¸å…³ç»„ä»¶'
          - 'OpenWrt æ’ä»¶'
          - 'Golang ç¼–è¯‘å·¥å…·'
          - 'Realtek ç½‘å¡é©±åŠ¨'
          - 'æ— çº¿å†…æ ¸é©±åŠ¨'        # mt76 + mac80211
          - 'Rockchip å¹³å°æºç '     # target_linux_rockchip-6.x
          - 'é€šç”¨å¹³å°æºç '         # target_linux_generic

jobs:
  build:
    name: ðŸŸ¢ åŒæ­¥æ¨¡å— â†’ ${{ github.event.inputs.target }}
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash

    steps:
    - name: ðŸ“¥ æ‹‰å–ä»“åº“æºç 
      continue-on-error: true
      uses: actions/checkout@main
      with:
        path: AutoSync

    - name: ðŸš€ Runner çŽ¯å¢ƒå‡†å¤‡ä¸Ž Git é…ç½®
      run : |
        sudo timedatectl set-timezone 'Asia/Shanghai'
        git config --global user.email "2519840456@qq.com"
        git config --global user.name "Xiaokailnol"

    - name: ðŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯å±•ç¤º
      run: |
        echo -e "\n\e[1;32mCPU:\e[0m"
        echo "$(grep 'model name' /proc/cpuinfo | head -1 | awk -F ': ' '{print $2}') ($(grep 'cpu MHz' /proc/cpuinfo | head -1 | awk -F ': ' '{print $2}')MHz) x $(grep processor /proc/cpuinfo  | wc -l)"
        echo -e "\n\e[1;32mMemory:\e[0m"
        free -h
        echo -e "\n\e[1;32mStorage:\e[0m"
        df -Th / /mnt
        echo -e "\n\e[1;32mSystem:\e[0m"
        lsb_release -a
        echo -e "\n\e[1;32mKernel:\e[0m"
        uname -a
        echo

    - name: ðŸŒ éƒ¨ç½² Caddy æœåŠ¡çŽ¯å¢ƒ
      run: |
        sudo curl -sL -o /usr/bin/caddy https://github.com/Xiaokailnol/AutoSync/releases/download/tools/caddy
        sudo chmod 755 /usr/bin/caddy
        echo ":8080 {" > caddyfile
        echo "    root * $(pwd)/AutoSync" >> caddyfile
        echo "    file_server browse" >> caddyfile
        echo "}" >> caddyfile
        sudo /usr/bin/caddy start --config caddyfile --adapter caddyfile
